<!-- === Mini-Looper v2 – Guitar + endless percussion carousel ========= -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Spinnaker&display=swap">

<style>
  :root{
    --green:#1fa382; --red:#c44e3a; --gold:#e0b04f;
    --fg:#f8f8f8; --bg:#000; --r:6px;
  }
  body{font-family:Spinnaker,sans-serif;background:var(--bg);color:var(--fg);
       margin:0;padding:0 20px 24px;}
  h2{margin:18px 0 10px;font-size:22px;text-align:center;}
  .status{font-size:14px;opacity:.8;text-align:center;margin-bottom:14px;}
  .btn{border:0;border-radius:var(--r);padding:8px 18px;font:16px/1 Spinnaker,sans-serif;
       cursor:pointer;transition:background .15s,transform .1s;}
  .btn:disabled{opacity:.35;cursor:default;}
  .gold{background:var(--gold);color:#000;}
  .gold:hover:not(:disabled){transform:scale(1.05);}
  .green{background:var(--green);color:#fff;}
  .green:hover:not(:disabled){transform:scale(1.05);}
  .red{background:var(--red);color:#fff;}
  .red:hover:not(:disabled){transform:scale(1.05);}
  #masterRow{display:none;justify-content:center;margin-bottom:18px;}

  #panel{max-width:460px;margin:0 auto;}
  .track-row{display:flex;align-items:center;gap:10px;margin-top:12px;}
  .track-row span{width:120px;font-size:15px;}
  .carouselNav{display:flex;align-items:center;gap:8px;margin-top:4px;justify-content:center;}
  .arrow{font-size:22px;cursor:pointer;user-select:none;}
  .arrow:active{transform:scale(0.9);}
</style>

<h2>Mini&nbsp;Looper v2</h2>

<div id="masterRow">
  <button id="killAll" class="btn red">🛑 Stop All</button>
</div>

<div id="status" class="status">Tone.js loading…</div>
<div id="panel"></div>

<!-- Tone.js -->
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
<script>
/* ── quick logger ─────────────────────────────────────────── */
const status = document.getElementById('status');
const log = m => { status.textContent = m; console.log('[Looper]', m); };

/* ── base + variations data ───────────────────────────────── */
const baseTrack = {
  id:'GTR', label:'🎸 Guitar', url:'https://kumbengo.github.io/groove-lab/Clave.wav'
};

const variations = [
  { id:'VAR1', label:'Variation A', url:'https://kumbengo.github.io/groove-lab/AfroPerc1.wav' },
  { id:'VAR2', label:'Variation B', url:'https://kumbengo.github.io/groove-lab/AfroPerc2.wav' }
];

/* ── state holders ───────────────────────────────────────── */
const players = {};          // id → Tone.Player
const btns    = {};          // id → {play,stop}
let currentVarIdx = 0;       // which variation is visible / controllable
let loaded = 0, unlocked=false;

/* ── build UI + players ──────────────────────────────────── */
const panel = document.getElementById('panel');

/* helper to create a row */
function addRow(track){
  const row = document.createElement('div');
  row.className='track-row';
  row.innerHTML=`
    <span>${track.label}</span>
    <button class="btn green play" disabled>Play</button>
    <button class="btn red  stop" disabled>Stop</button>`;
  panel.appendChild(row);
  btns[track.id] = {
    play: row.querySelector('.play'),
    stop: row.querySelector('.stop')
  };
  return row;
}

/* Base track row first */
addRow(baseTrack);

/* Carousel container */
const varRow = addRow(variations[0]);   // initially show Variation A

/* Carousel arrows */
const nav = document.createElement('div');
nav.className='carouselNav';
nav.innerHTML=`
   <span id="navLeft"  class="arrow">⬅</span>
   <span id="navRight" class="arrow">➡</span>`;
panel.appendChild(nav);

document.getElementById('navLeft').onclick  = ()=>cycleVar(-1);
document.getElementById('navRight').onclick = ()=>cycleVar(+1);

/* Master stop row */
const masterRow = document.getElementById('masterRow');
const killAll   = document.getElementById('killAll');

/* ── create Tone.Players (begin loading) ─────────────────── */
[baseTrack, ...variations].forEach(t=>{
  const p = new Tone.Player({
      url:t.url, loop:false, autostart:false,
      onload:onFileReady, onerror:e=>log(`❌ ${t.label} error: ${e}`)})
      .toDestination();
  p.sync().start(0);  // follow Transport
  p.mute=true;
  players[t.id]=p;
});

/* ── on buffer decode complete ───────────────────────────── */
function onFileReady(){
  loaded += 1;
  if(loaded < variations.length+1){      // +1 for guitar
    log(`🎧 ${loaded}/${variations.length+1} buffered…`);
    return;
  }
  masterRow.style.display='flex';
  enableKillAll();
  enableTrackButtons();
  log('🎧 All loops buffered – click Guitar Play');
}

/* ── enable UI behaviours ────────────────────────────────── */
function enableTrackButtons(){
  /* Base */
  hook(baseTrack.id);
  /* Visible variation (currentVarIdx === 0 initially) */
  hook(variations[currentVarIdx].id);
}
function hook(id){
  const p = players[id];
  const {play,stop} = btns[id];
  enable(play);
  play.onclick = async ()=>{
    await unlockIfNeeded();
    startTransportIfNeeded();
    if(id.startsWith('VAR')){
      // mute all other variations
      variations.forEach(v=>{
        if(v.id !== id){ players[v.id].mute=true; swapOff(v.id); }
      });
    }
    p.mute=false; swap(id); log(`▶ ${getLabel(id)}`);
  };
  stop.onclick = ()=>{
    p.mute=true; swap(id); log(`⏹ ${getLabel(id)}`);
  };
}

/* ── carousel logic ──────────────────────────────────────── */
function cycleVar(dir){
  const oldId = variations[currentVarIdx].id;
  players[oldId].mute=true;
  swapOff(oldId);

  // compute next index (wrap)
  currentVarIdx = (currentVarIdx + dir + variations.length) % variations.length;
  const newVar = variations[currentVarIdx];
  // update UI label text
  varRow.querySelector('span').textContent = newVar.label;
  // re-hook buttons to the newly visible variation
  const {play,stop} = btns[newVar.id];
  varRow.querySelector('.play').replaceWith(play);
  varRow.querySelector('.stop').replaceWith(stop);
  hook(newVar.id);
  log(`↔ Showing ${newVar.label}`);
}

/* ── master kill-all button ─────────────────────────────── */
function enableKillAll(){
  killAll.onclick = ()=>{
    Tone.Transport.stop();
    Object.values(players).forEach(p=>p.mute=true);
    // reset button states
    [baseTrack, ...variations].forEach(t=>swapOff(t.id));
    log('🛑 All loops stopped');
  };
}

/* ── helper utils ───────────────────────────────────────── */
async function unlockIfNeeded(){
  if(unlocked) return;
  await Tone.start(); unlocked=true; log('🔓 Audio unlocked');
}
function startTransportIfNeeded(){
  if(Tone.Transport.state === 'started') return;
  Tone.Transport.loop = true;
  Tone.Transport.loopEnd = '8m';   // 8 measures (adjust to taste)
  Tone.Transport.start('+0.1');
}
function swap(id){
  const {play,stop}=btns[id];
  enable(stop); disable(play);
}
function swapOff(id){
  const {play,stop}=btns[id];
  enable(play); disable(stop);
}
function enable(b){ b.disabled=false; b.removeAttribute('disabled'); }
function disable(b){ b.disabled=true; b.setAttribute('disabled',''); }
function getLabel(id){
  if(id===baseTrack.id) return baseTrack.label;
  return variations.find(v=>v.id===id).label;
}

/* ── tidy-up on navigation away ─────────────────────────── */
window.addEventListener('unload',()=>{
  Tone.Transport.stop();
  Object.values(players).forEach(p=>p.dispose());
});
</script>
