<!-- === Mini-Looper v2 – two-column layout ========= -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Spinnaker&display=swap">

<style>
  :root {
    --green: #1fa382; 
    --red:   #c44e3a; 
    --gold:  #e0b04f;
    --fg: #f8f8f8; 
    --bg: #000; 
    --r: 6px;
  }
  body {
    font-family: Spinnaker, sans-serif;
    background: var(--bg);
    color: var(--fg);
    margin: 0;
    padding: 0 20px 24px;
  }
  h2 {
    margin: 18px 0 10px;
    font-size: 22px;
    text-align: center;
  }
  .status {
    font-size: 14px;
    opacity: .8;
    text-align: center;
    margin-bottom: 14px;
  }
  .btn {
    border: 0;
    border-radius: var(--r);
    padding: 8px 18px;
    font: 16px/1 Spinnaker, sans-serif;
    cursor: pointer;
    transition: background .15s, transform .1s;
  }
  .btn:disabled {
    opacity: .35;
    cursor: default;
  }
  .gold { background: var(--gold); color: #000; }
  .gold:hover:not(:disabled) { transform: scale(1.05); }
  .green { background: var(--green); color: #fff; }
  .green:hover:not(:disabled) { transform: scale(1.05); }
  .red { background: var(--red); color: #fff; }
  .red:hover:not(:disabled) { transform: scale(1.05); }

  /* ── New two-column container ───────────────────────── */
  #panel {
    max-width: 700px;
    margin: 0 auto;
  }
  .looper-container {
    display: flex;
    gap: 20px;
  }
  .looper-container .col {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .base-col {
    /* narrower left column */
    max-width: 200px;
  }
  .carousel-col {
    /* wider right column */
    flex: 2;
  }

  .track-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 12px;
  }
  .track-row span {
    width: 120px;
    font-size: 15px;
  }
  .carouselNav {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    justify-content: center;
  }
  .arrow {
    font-size: 22px;
    cursor: pointer;
    user-select: none;
  }
  .arrow:active { transform: scale(0.9); }

  #masterRow {
    display: none;
    justify-content: center;
    margin-bottom: 18px;
  }
</style>

<h2>Mini&nbsp;Looper v2</h2>

<div id="masterRow">
  <button id="killAll" class="btn red">🛑 Stop All</button>
</div>

<div id="status" class="status">Tone.js loading…</div>
<div id="panel"></div>

<!-- Tone.js -->
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
<script>
/* ── quick logger ─────────────────────────────────────────── */
const status = document.getElementById('status');
const log = m => { status.textContent = m; console.log('[Looper]', m); };

/* ── base + variations data ───────────────────────────────── */
const baseTrack = {
  id: 'BASE',
  label: 'Master Loop',
  url: 'https://kumbengo.github.io/groove-lab/Clave.wav'
};

const variations = [
  { id:'VAR1', label:'Variation A', url:'https://kumbengo.github.io/groove-lab/AfroPerc1.wav' },
  { id:'VAR2', label:'Variation B', url:'https://kumbengo.github.io/groove-lab/AfroPerc2.wav' }
];

/* ── state holders ───────────────────────────────────────── */
const players = {};      // id → Tone.Player
const btns    = {};      // id → { play, stop }
let currentVarIdx = 0;
let loaded = 0, unlocked = false;

/* ── build two-column UI container ────────────────────────── */
const panel = document.getElementById('panel');
panel.innerHTML = `
  <div class="looper-container">
    <div class="col base-col"></div>
    <div class="col carousel-col"></div>
  </div>
`;
const baseCol     = panel.querySelector('.base-col');
const carouselCol = panel.querySelector('.carousel-col');
const masterRow   = document.getElementById('masterRow');
const killAll     = document.getElementById('killAll');

/* ── helper to create a track row in given parent ─────────── */
function addRow(track, parent) {
  const row = document.createElement('div');
  row.className = 'track-row';
  row.innerHTML = `
    <span>${track.label}</span>
    <button class="btn green play" disabled>Play</button>
    <button class="btn red   stop" disabled>Stop</button>
  `;
  parent.appendChild(row);
  btns[track.id] = {
    play: row.querySelector('.play'),
    stop: row.querySelector('.stop')
  };
  return row;
}

/* ── create rows ──────────────────────────────────────────── */
addRow(baseTrack, baseCol);
const varRow = addRow(variations[0], carouselCol);

/* ── carousel arrows in right column ─────────────────────── */
const nav = document.createElement('div');
nav.className = 'carouselNav';
nav.innerHTML = `
  <span id="navLeft"  class="arrow">⬅</span>
  <span id="navRight" class="arrow">➡</span>
`;
carouselCol.appendChild(nav);
document.getElementById('navLeft').onclick  = () => cycleVar(-1);
document.getElementById('navRight').onclick = () => cycleVar(+1);

/* ── instantiate Tone.Players (begin loading) ────────────── */
[ baseTrack, ...variations ].forEach(t => {
  const p = new Tone.Player({
      url: t.url,
      loop: false,
      autostart: false,
      onload: onFileReady,
      onerror: e => log(`❌ ${t.label} error: ${e}`)
    })
    .toDestination()
    .sync().start(0); // sync to Transport
  p.mute = true;
  players[t.id] = p;
});

/* ── when each file finishes buffering ───────────────────── */
function onFileReady() {
  loaded++;
  const total = 1 + variations.length;
  if (loaded < total) {
    log(`🎧 ${loaded}/${total} buffered…`);
    return;
  }
  masterRow.style.display = 'flex';
  enableKillAll();
  enableTrackButtons();
  log('🎧 All loops buffered – click Master Play');
}

/* ── enable play/stop handlers ───────────────────────────── */
function enableTrackButtons() {
  hook(baseTrack.id, baseCol);
  hook(variations[currentVarIdx].id, carouselCol);
}
function hook(id, _parent) {
  const p = players[id];
  const { play, stop } = btns[id];
  enable(play);
  play.onclick = async () => {
    await unlockIfNeeded();
    startTransportIfNeeded();
    if (id !== baseTrack.id) {
      // mute other variations
      variations.forEach(v => {
        if (v.id !== id) {
          players[v.id].mute = true;
          swapOff(v.id);
        }
      });
    }
    p.mute = false;
    swap(id);
    log(`▶ ${getLabel(id)}`);
  };
  stop.onclick = () => {
    p.mute = true;
    swap(id);
    log(`⏹ ${getLabel(id)}`);
  };
}

/* ── carousel navigation ─────────────────────────────────── */
function cycleVar(dir) {
  // stop old
  const old = variations[currentVarIdx].id;
  players[old].mute = true;
  swapOff(old);

  // wrap index
  currentVarIdx = (currentVarIdx + dir + variations.length) % variations.length;
  const next = variations[currentVarIdx];
  // update label in UI
  varRow.querySelector('span').textContent = next.label;
  // swap in the correct buttons
  const { play, stop } = btns[next.id];
  varRow.querySelector('.play').replaceWith(play);
  varRow.querySelector('.stop').replaceWith(stop);
  hook(next.id, carouselCol);
  log(`↔ Showing ${next.label}`);
}

/* ── master Stop All ─────────────────────────────────────── */
function enableKillAll() {
  killAll.onclick = () => {
    Tone.Transport.stop();
    Object.values(players).forEach(p => p.mute = true);
    [ baseTrack, ...variations ].forEach(t => swapOff(t.id));
    log('🛑 All loops stopped');
  };
}

/* ── utils ───────────────────────────────────────────────── */
async function unlockIfNeeded() {
  if (!unlocked) {
    await Tone.start();
    unlocked = true;
    log('🔓 Audio unlocked');
  }
}
function startTransportIfNeeded() {
  if (Tone.Transport.state !== 'started') {
    Tone.Transport.loop    = true;
    Tone.Transport.loopEnd = '8m';
    Tone.Transport.start('+0.1');
  }
}
function swap(id)   { disable(btns[id].play); enable(btns[id].stop); }
function swapOff(id) { enable(btns[id].play); disable(btns[id].stop); }
function enable(b)  { b.disabled = false; b.removeAttribute('disabled'); }
function disable(b) { b.disabled = true;  b.setAttribute('disabled',''); }
function getLabel(id) {
  return id === baseTrack.id
    ? baseTrack.label
    : variations.find(v => v.id === id).label;
}

/* ── clean-up on page unload ─────────────────────────────── */
window.addEventListener('unload', () => {
  Tone.Transport.stop();
  Object.values(players).forEach(p => p.dispose());
});
</script>
