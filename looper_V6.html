<h2 style="color:#fff">Mini Looper v2 (Minimal)</h2>
<button id="killAll" disabled style="color:#fff;background:#333">Stop All</button>

<!-- two columns -->
<div id="panel" style="display:flex;gap:32px;margin-top:12px;color:#fff">
  <div id="base"></div>
  <div id="carousel"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
<script>
  /* --- config ---------------------------------------------------- */
  const base = { id:'BASE', label:'Master Loop',
                 url:'https://kumbengo.github.io/groove-lab/Clave.wav' };

  const vars = [
    { id:'V1', label:'Variation A',
      url:'https://kumbengo.github.io/groove-lab/AfroPerc1.wav' },
    { id:'V2', label:'Variation B',
      url:'https://kumbengo.github.io/groove-lab/AfroPerc2.wav' }
  ];

  /* --- dom ------------------------------------------------------- */
  const killBtn = document.getElementById('killAll');
  const baseCol = document.getElementById('base');
  const carCol  = document.getElementById('carousel');

  /* make a [label][toggle] row */
  function makeRow(t, parent){
    const row = document.createElement('div');
    const lab = document.createElement('span');
    lab.textContent = t.label;
    const btn = document.createElement('button');
    btn.textContent = 'Play';
    btn.style = 'margin-left:8px;color:#fff;background:#444';
    btn.disabled = true;
    row.append(lab, btn);
    parent.append(row);
    return btn;
  }

  const baseBtn = makeRow(base, baseCol);             // master row
  const varBtn  = makeRow(vars[0], carCol);           // visible variation row
  let current   = 0;                                  // which variation shown

  /* arrow nav buttons */
  ['<','>'].forEach((s,i)=>{
    const b=document.createElement('button');
    b.textContent=s; b.style='color:#fff;background:#222;margin-right:4px';
    carCol.append(b);
    b.onclick=()=> cycle(i?1:-1);
  });

  /* --- players --------------------------------------------------- */
  const players = {};
  [...[base],...vars].forEach(t=>{
    players[t.id]=new Tone.Player({url:t.url,loop:true,autostart:false})
                     .toDestination();
  });

  let loaded=0, unlocked=false, masterStarted=false;

  Object.values(players).forEach(p=>p.onload = onLoad);

  function onLoad(){
    if(++loaded < vars.length+1) return;
    killBtn.disabled = false;
    baseBtn.disabled = false;
    varBtn.disabled  = false;
  }

  /* --- helper: sync-start a player ------------------------------- */
  function startSynced(player){
    const refTime   = Tone.now();
    const loopDur   = players[base.id].buffer.duration;
    const elapsed   = (Tone.Transport.seconds % loopDur);
    player.start(refTime, elapsed);
  }

  /* --- master toggle --------------------------------------------- */
  baseBtn.onclick = async ()=>{
    if(baseBtn.textContent==='Play'){
      if(!unlocked){ await Tone.start(); unlocked=true; }
      if(!masterStarted){
        Tone.Transport.loop=true;
        Tone.Transport.start();
        masterStarted=true;
      }
      startSynced(players[base.id]);
      baseBtn.textContent='Stop';
    }else{
      players[base.id].stop();
      baseBtn.textContent='Play';
    }
  };

  /* --- variation toggle ------------------------------------------ */
  function hookVarButton(btn, track){
    btn.onclick=()=>{
      const p = players[track.id];
      if(btn.textContent==='Play'){
        if(baseBtn.textContent!=='Stop') baseBtn.onclick(); // auto-start master
        vars.forEach(v=>{ players[v.id].stop(); });         // stop others
        startSynced(p);
        btn.textContent='Stop';
      }else{
        p.stop();
        btn.textContent='Play';
      }
    };
  }
  hookVarButton(varBtn, vars[0]);

  /* --- cycle left/right ------------------------------------------ */
  function cycle(dir){
    players[vars[current].id].stop();          // stop current
    varBtn.textContent='Play';

    current = (current + dir + vars.length) % vars.length;
    const t = vars[current];

    varBtn.previousSibling.textContent = t.label; // swap label
    hookVarButton(varBtn, t);                     // retarget button
  }

  /* --- stop all --------------------------------------------------- */
  killBtn.onclick=()=>{
    Tone.Transport.stop(); masterStarted=false;
    Object.values(players).forEach(p=>p.stop());
    baseBtn.textContent='Play';
    varBtn.textContent ='Play';
  };

  window.addEventListener('unload',()=>Object.values(players).forEach(p=>p.dispose()));
</script>
